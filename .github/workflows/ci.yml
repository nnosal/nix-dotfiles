name: Nix Flake CI

on:
  push:
    branches: [main, jules-ultimate-dotfiles-init-*]
  pull_request:

jobs:
  # ========================================
  # JOB 1: Validation Syntaxique
  # ========================================
  validate:
    name: "üîç Flake Check & Linters"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      # 1. Validation Nix Flake
      - name: Nix Flake Check
        run: nix flake check --show-trace
      
      # 2. Validation Mise (syntaxe uniquement)
      - name: Validate mise.toml
        run: |
          nix shell nixpkgs#mise -c bash -c '
            echo "üìã V√©rification de mise.toml..."
            
            # Parse la config
            mise config ls > /dev/null || exit 1
            
            # Liste les tasks
            echo "Tasks d√©finies:"
            mise tasks ls
            
            # V√©rifie les tools d√©clar√©s
            echo "Tools d√©clar√©s:"
            mise ls --json | head -20
            
            echo "‚úÖ mise.toml est valide"
          '
      
      # 3. V√©rification marqueurs injection
      - name: Validate Injection Markers
        run: |
          ERROR=0
          
          if [ -f modules/darwin/apps.nix ]; then
            if ! grep -q "# %% CASKS %%" modules/darwin/apps.nix; then
              echo "‚ùå Marker CASKS manquant dans modules/darwin/apps.nix"
              ERROR=1
            fi
          fi
          
          if [ -f modules/common/packages.nix ]; then
            if ! grep -q "# %% PACKAGES %%" modules/common/packages.nix; then
              echo "‚ùå Marker PACKAGES manquant dans modules/common/packages.nix"
              ERROR=1
            fi
          fi
          
          if [ $ERROR -eq 0 ]; then
            echo "‚úÖ Tous les marqueurs d'injection sont pr√©sents"
          else
            exit 1
          fi

  # ========================================
  # JOB 2: Build Configurations
  # ========================================
  build-configs:
    name: "üî® Build ${{ matrix.name }}"
    runs-on: ${{ matrix.os }}
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "macOS (macbook-pro)"
            config: darwinConfigurations."macbook-pro".system
            os: macos-14
            
          - name: "Linux VPS (contabo1)"
            config: nixosConfigurations.contabo1.config.system.build.toplevel
            os: ubuntu-latest
            
          - name: "Linux Test"
            config: nixosConfigurations.test-linux.config.system.build.toplevel
            os: ubuntu-latest
            
          - name: "WSL (Home Manager)"
            config: homeConfigurations.wsl.activationPackage
            os: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - name: Build Configuration
        run: |
          echo "üî® Building ${{ matrix.name }}..."
          nix build .#${{ matrix.config }} --dry-run --show-trace

  # ========================================
  # JOB 3: Security Audit
  # ========================================
  security:
    name: "üîí Security Audit"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Detect Private Keys & Secrets
        run: |
          echo "üîç Scanning for hardcoded secrets..."
          
          PATTERNS=(
            "BEGIN.*PRIVATE KEY"
            "BEGIN RSA PRIVATE KEY"
            "BEGIN OPENSSH PRIVATE KEY"
            "AKIA[0-9A-Z]{16}"
            "ghp_[0-9a-zA-Z]{36}"
            "sk-[0-9a-zA-Z]{48}"
            "xox[baprs]-[0-9a-zA-Z-]+"
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            if grep -rE "$pattern" . \
              --exclude-dir=.git \
              --exclude-dir=result \
              --exclude="*.md" \
              --exclude="ci.yml"; then
              echo "‚ùå Dangerous pattern detected: $pattern"
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo "‚ùå CRITICAL: Secrets detected in repository!"
            exit 1
          fi
          
          echo "‚úÖ No hardcoded secrets found"
      
      - name: Validate Fnox Config (Zero-Trust)
        run: |
          if [ -f fnox.toml ]; then
            echo "üõ°Ô∏è Validating fnox.toml (must contain pointers only)..."
            
            # V√©rifier qu'il n'y a que des URIs keychain:// ou pass://
            if grep -E '^\s*[A-Z_]+\s*=\s*"' fnox.toml | grep -v 'keychain://' | grep -v 'pass://'; then
              echo "‚ùå ERROR: fnox.toml contains values that are not keychain:// or pass:// URIs!"
              echo "All secrets must be pointers, not actual values."
              exit 1
            fi
            
            echo "‚úÖ fnox.toml follows Zero-Trust principle (pointers only)"
          else
            echo "‚ö†Ô∏è fnox.toml not found (OK if not created yet)"
          fi

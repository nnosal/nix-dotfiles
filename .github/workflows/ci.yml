name: Nix Flake CI

on:
  push:
    branches: [main, jules-ultimate-dotfiles-init-*]
  pull_request:

jobs:
  # ========================================
  # JOB 1: Validation Syntaxique
  # ========================================
  validate:
    name: "ðŸ” Flake Check & Linters"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - uses: cachix/cachix-action@v15
        with:
          name: nnosal-dotfiles
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      
      # 1. Validation Nix Flake
      - name: Nix Flake Check
        run: nix flake check --show-trace
      
      # 2. Validation Mise (syntaxe uniquement)
      - name: Validate mise.toml
        run: |
          nix shell nixpkgs#mise -c bash -c '
            echo "ðŸ“‹ VÃ©rification de mise.toml..."
            
            # Parse la config
            mise config ls > /dev/null || exit 1
            
            # Liste les tasks
            echo "Tasks dÃ©finies:"
            mise tasks ls
            
            # VÃ©rifie les tools dÃ©clarÃ©s
            echo "Tools dÃ©clarÃ©s:"
            mise ls --json | head -20
            
            echo "âœ… mise.toml est valide"
          '
      
      # 3. VÃ©rification marqueurs injection
      - name: Validate Injection Markers
        run: |
          ERROR=0
          
          if [ -f modules/darwin/apps.nix ]; then
            if ! grep -q "# %% CASKS %%" modules/darwin/apps.nix; then
              echo "âŒ Marker CASKS manquant dans modules/darwin/apps.nix"
              ERROR=1
            fi
          fi
          
          if [ -f modules/common/packages.nix ]; then
            if ! grep -q "# %% PACKAGES %%" modules/common/packages.nix; then
              echo "âŒ Marker PACKAGES manquant dans modules/common/packages.nix"
              ERROR=1
            fi
          fi
          
          if [ $ERROR -eq 0 ]; then
            echo "âœ… Tous les marqueurs d'injection sont prÃ©sents"
          else
            exit 1
          fi

  # ========================================
  # JOB 2: Build Configurations
  # ========================================
  build-configs:
    name: "ðŸ”¨ Build ${{ matrix.name }}"
    runs-on: ${{ matrix.os }}
    needs: validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "macOS (macbook-pro)"
            config: darwinConfigurations."macbook-pro".system
            os: macos-14
            is-darwin: true
            
          - name: "Linux VPS (contabo1)"
            config: nixosConfigurations.contabo1.config.system.build.toplevel
            os: ubuntu-latest
            is-darwin: false
            
          - name: "Linux Test"
            config: nixosConfigurations.test-linux.config.system.build.toplevel
            os: ubuntu-latest
            is-darwin: false
            
          - name: "WSL (Home Manager)"
            config: homeConfigurations.wsl.activationPackage
            os: ubuntu-latest
            is-darwin: false
    steps:
      - uses: actions/checkout@v4
      
      - uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
      
      - uses: cachix/cachix-action@v15
        with:
          name: nnosal-dotfiles
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
      
      - name: Build Configuration
        run: |
          echo "ðŸ”¨ Building ${{ matrix.name }}..."
          cachix watch-exec nnosal-dotfiles -- \
            nix build .#${{ matrix.config }} --dry-run --show-trace
      
      - name: Test nix-darwin switch (README validation)
        if: matrix.is-darwin == true
        run: |
          echo "ðŸ§ª Testing nix-darwin switch (simulating fresh install)..."
          
          # DÃ©tecter l'utilisateur actuel
          export CURRENT_USER=$(whoami)
          echo "ðŸ‘¤ Current user: $CURRENT_USER"
          
          # CrÃ©er un override temporaire pour le username
          cat > ci-override.nix << EOF
          { config, pkgs, ... }:
          {
            users.users.${CURRENT_USER} = {
              name = "${CURRENT_USER}";
              home = "/Users/${CURRENT_USER}";
            };
            
            home-manager.users.${CURRENT_USER} = {
              home.username = "${CURRENT_USER}";
              home.homeDirectory = "/Users/${CURRENT_USER}";
            };
          }
          EOF
          
          # Modifier temporairement le flake pour inclure l'override
          cp flake.nix flake.nix.bak
          
          # Ajouter l'import de ci-override.nix dans les modules darwin
          nix eval --impure --expr '
            let
              flake = builtins.getFlake (toString ./.);
              modified = flake // {
                darwinConfigurations = builtins.mapAttrs (name: config:
                  config // {
                    modules = config.modules ++ [ ./ci-override.nix ];
                  }
                ) flake.darwinConfigurations;
              };
            in
              modified
          ' || true
          
          # ExÃ©cuter le switch avec l'utilisateur adaptÃ©
          cachix watch-exec nnosal-dotfiles -- \
            sudo nix --extra-experimental-features "nix-command flakes" \
              run nix-darwin -- switch --flake .#macbook-pro \
              --override-input nixpkgs nixpkgs \
              --impure

  # ========================================
  # JOB 3: Windows Bootstrap Test
  # ========================================
  test-windows-bootstrap:
    name: "ðŸªŸ Test Windows Bootstrap"
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      
      - name: Update bootstrap.ps1 URLs
        shell: pwsh
        run: |
          Write-Host "ðŸ”§ Updating bootstrap.ps1 with correct repo URLs..." -ForegroundColor Cyan
          
          # Remplacer les URLs obsolÃ¨tes dans bootstrap.ps1
          $content = Get-Content bootstrap.ps1 -Raw
          $content = $content -replace 'nnosal/dotfiles', 'nnosal/nix-dotfiles'
          $content = $content -replace 'https://github.com/nnosal/dotfiles.git', 'https://github.com/nnosal/nix-dotfiles.git'
          Set-Content bootstrap.ps1 -Value $content
          
          Write-Host "âœ… URLs updated" -ForegroundColor Green
      
      - name: Test bootstrap.ps1 (Dry Run)
        shell: pwsh
        run: |
          Write-Host "ðŸ§ª Testing Windows bootstrap script..." -ForegroundColor Cyan
          
          # VÃ©rifier que le script est valide PowerShell
          $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content bootstrap.ps1 -Raw), [ref]$null)
          
          Write-Host "âœ… bootstrap.ps1 syntax is valid" -ForegroundColor Green
          
          # Afficher le contenu pour debug
          Write-Host "ðŸ“œ Script content:" -ForegroundColor Yellow
          Get-Content bootstrap.ps1
          
          # Simuler l'exÃ©cution (sans vraiment installer)
          Write-Host "ðŸŽ¯ Simulating bootstrap execution..." -ForegroundColor Cyan
          
          # VÃ©rifier que winget existe
          if (Get-Command winget -ErrorAction SilentlyContinue) {
            Write-Host "âœ… Winget is available" -ForegroundColor Green
          } else {
            Write-Host "âš ï¸ Winget not found (expected in CI)" -ForegroundColor Yellow
          }
          
          # VÃ©rifier que Git existe
          if (Get-Command git -ErrorAction SilentlyContinue) {
            Write-Host "âœ… Git is available" -ForegroundColor Green
            git --version
          } else {
            Write-Host "âŒ Git not found" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "âœ… Windows bootstrap test completed" -ForegroundColor Green

  # ========================================
  # JOB 4: Security Audit (Disabled)
  # ========================================
  # security:
  #   name: "ðŸ”’ Security Audit"
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
      
  #     - uses: cachix/install-nix-action@v25
  #       with:
  #         extra_nix_config: |
  #           experimental-features = nix-command flakes
      
  #     - name: Detect Private Keys & Secrets (using hk)
  #       run: |
  #         echo "ðŸ” Scanning for hardcoded secrets using hk..."
          
  #         # Build hk from flake
  #         nix build .#hk
          
  #         # Run security scan with hk
  #         ./result/bin/hk scan . \
  #           --exclude .git \
  #           --exclude result \
  #           --exclude '*.md' \
  #           --format github-actions
          
  #         echo "âœ… Security scan completed"
      
  #     - name: Validate Fnox Config (Zero-Trust)
  #       run: |
  #         if [ -f fnox.toml ]; then
  #           echo "ðŸ›¡ï¸ Validating fnox.toml (must contain pointers only)..."
            
  #           # VÃ©rifier qu'il n'y a que des URIs keychain:// ou pass://
  #           if grep -E '^\s*[A-Z_]+\s*=\s*"' fnox.toml | grep -v 'keychain://' | grep -v 'pass://'; then
  #             echo "âŒ ERROR: fnox.toml contains values that are not keychain:// or pass:// URIs!"
  #             echo "All secrets must be pointers, not actual values."
  #             exit 1
  #           fi

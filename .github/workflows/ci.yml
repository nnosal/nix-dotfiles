name: Nix Flake CI

on:
  push:
    branches: [main, jules-*]
  pull_request:

jobs:
  test-unix-bootstrap:
    name: "ðŸ”¨ Build ${{ matrix.name }}"
    runs-on: ${{ matrix.os }}
    # needs: validate # Ã€ dÃ©commenter si vous avez un job nommÃ© validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Linux Test"
            config: 
              name: "test-linux"
              build: nixosConfigurations.test-linux.config.system.build.toplevel
            os: ubuntu-latest
            is-darwin: false
          - name: "macOS (macbook-pro)"
            config: 
              name: "macbook-pro"
              build: darwinConfigurations."macbook-pro".system
            os: macos-14
            is-darwin: true
    steps:
      - uses: actions/checkout@v4
      - name: Run Bootstrap and Build (Linux)
        if: matrix.is-darwin == false
        run: |
          echo "ðŸ”¨ Test bootstrap ${{ matrix.name }}..."
          export CI=true
          chmod +x ./bootstrap.sh ./i.sh
          . ./bootstrap.sh
          echo "ðŸ”¨ Building ${{ matrix.name }}..."
          nix build .#${{ matrix.config.build }} --dry-run --show-trace
        shell: bash
      - name: Run Bootstrap and Build (macOS)
        if: matrix.is-darwin == true
        run: |
          echo "ðŸ”¨ Testing nix-darwin switch on ${{ matrix.name }}..."
          export CI=true;
          . ./bootstrap.sh
          nix build .#${{ matrix.config.build }} --show-trace
          nh darwin switch .
          #sudo darwin-rebuild switch --flake .#${{ matrix.config.name }} --dry-run
  test-windows-bootstrap:
    name: "ðŸªŸ Test Windows Bootstrap"
    runs-on: windows-latest
    #needs: validate
    steps:
      - uses: actions/checkout@v4
      - name: Test bootstrap.ps1 (Dry Run)
        shell: pwsh
        run: |
          Write-Host "ðŸ§ª Testing Windows bootstrap script..." -ForegroundColor Cyan
          irm https://raw.githubusercontent.com/nnosal/nix-dotfiles/refs/heads/main/bootstrap.ps1 | iex

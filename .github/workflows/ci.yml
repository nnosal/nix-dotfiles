name: Nix Flake CI

on:
  push:
    branches: [main, jules-*]
  pull_request:

jobs:
  test-unix-bootstrap:
    name: "ðŸ”¨ Build ${{ matrix.name }}"
    runs-on: ${{ matrix.os }}
    # needs: validate # Ã€ dÃ©commenter si vous avez un job nommÃ© validate
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "Linux Test"
            config: nixosConfigurations.test-linux.config.system.build.toplevel
            os: ubuntu-latest
            is-darwin: false
          - name: "macOS (macbook-pro)"
            config: darwinConfigurations."macbook-pro".system
            os: macos-14
            is-darwin: true
    steps:
      - uses: actions/checkout@v4

      # Note : bootstrap.sh installe Nix, mais dans GitHub Actions, 
      # les changements de PATH ne survivent pas toujours entre les Ã©tapes 
      # ou au sein d'un mÃªme script complexe.
      - name: Run Bootstrap
        run: |
          echo "ðŸ”¨ Test bootstrap ${{ matrix.name }}..."
          export CI=true
          chmod +x ./bootstrap.sh ./i.sh
          ./bootstrap.sh
          echo "ðŸ”¨ Building ${{ matrix.name }}..."
          nix build .#${{ matrix.config }} --dry-run --show-trace
        shell: bash
  test-windows-bootstrap:
    name: "ðŸªŸ Test Windows Bootstrap"
    runs-on: windows-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      
      - name: Test bootstrap.ps1 (Dry Run)
        shell: pwsh
        run: |
          Write-Host "ðŸ§ª Testing Windows bootstrap script..." -ForegroundColor Cyan
          irm https://raw.githubusercontent.com/nnosal/nix-dotfiles/refs/heads/main/bootstrap.ps1 | iex
